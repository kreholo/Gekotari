<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Oyna - Gekkotari</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        #oyunCercevesi {
            width: 100%;
            height: 85vh;
            border: none;
            border-radius: 10px;
            background-color: #000;
            box-shadow: 0 0 20px rgba(80, 245, 137, 0.2);
            display: none;
        }
        /* Yılan Oyunu Stili */
        #yerelOyunAlani { display: none; }
        canvas { display: block; margin: 0 auto; border: 2px solid #50F589; background-color: #000; }
    </style>
</head>
<body>

    <header>
        <div class="container py-3">
            <a class="navbar-brand text-white" href="index.html"><i class="fas fa-arrow-left"></i> Ana Sayfaya Dön</a>
        </div>
    </header>

    <main class="container-fluid px-4">
        <div class="text-center mb-3">
            <h2 id="oyunBaslik" class="text-warning">Yükleniyor...</h2>
        </div>
        
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10">
                <iframe id="oyunCercevesi" src="" allowfullscreen></iframe>

                <div id="yerelOyunAlani" class="text-center">
                    <div class="d-flex justify-content-center gap-4 mb-3">
                        <h4 class="text-white">Puan: <span id="skor" class="text-success">0</span></h4>
                        <h4 class="text-white">En Yüksek: <span id="enYuksek" class="text-warning">0</span></h4>
                    </div>
                    <canvas id="oyunTahtasi" width="400" height="400"></canvas>
                    <p class="text-muted mt-3">WASD veya Ok Tuşları ile oyna</p>
                    <button onclick="location.reload()" class="btn btn-primary-custom">Yeniden Başlat</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const gelenOyunAdi = urlParams.get('ad');
            const tumOyunlar = JSON.parse(localStorage.getItem("tumOyunlar")) || [];
            
            // Oyunu Bul
            let bulunanOyun = tumOyunlar.find(oyun => oyun.ad === gelenOyunAdi);

            // Eğer bulamazsa ve isim 'Yılan' içeriyorsa varsayılan yap
            if(!bulunanOyun && gelenOyunAdi && gelenOyunAdi.includes("Yılan")) {
                bulunanOyun = { ad: "Yılan Oyunu", link: "yerel" };
            }

            if (bulunanOyun) {
                document.getElementById("oyunBaslik").innerText = bulunanOyun.ad;
                document.title = bulunanOyun.ad + " - Gekkotari";
                
                if (bulunanOyun.link === "yerel") {
                    // YILAN MODU
                    document.getElementById("yerelOyunAlani").style.display = "block";
                    baslatYilanOyunu();
                } else {
                    // IFRAME MODU (GitHub'da çalışır!)
                    const iframe = document.getElementById("oyunCercevesi");
                    iframe.src = bulunanOyun.link;
                    iframe.style.display = "block";
                }
            } else {
                document.getElementById("oyunBaslik").innerText = "Oyun Bulunamadı veya Linki Yok!";
            }
        });

        // --- Yılan Oyunu Mantığı ---
        function baslatYilanOyunu() {
            const canvas = document.getElementById("oyunTahtasi");
            const ctx = canvas.getContext("2d");
            let hiz=7, tileCount=20, tileSize=canvas.width/tileCount-2;
            let headX=10, headY=10, xHiz=0, yHiz=0, elmaX=5, elmaY=5;
            let yilanParcalari=[], kuyruk=2, skor=0, yonDegisti=false;

            document.addEventListener("keydown", tusBasildi);
            setInterval(oyunuCiz, 1000/hiz);

            function oyunuCiz() {
                headX+=xHiz; headY+=yHiz; yonDegisti=false;
                if(headX<0||headX>=tileCount||headY<0||headY>=tileCount) return reset();
                for(let p of yilanParcalari) if(p.x===headX && p.y===headY && kuyruk>2) return reset();
                
                ctx.fillStyle="black"; ctx.fillRect(0,0,canvas.width,canvas.height);
                ctx.fillStyle="lime";
                for(let p of yilanParcalari) ctx.fillRect(p.x*tileCount, p.y*tileCount, tileSize, tileSize);
                yilanParcalari.push({x:headX, y:headY});
                while(yilanParcalari.length>kuyruk) yilanParcalari.shift();

                if(elmaX===headX && elmaY===headY) {
                    kuyruk++; skor+=10; 
                    elmaX=Math.floor(Math.random()*tileCount); 
                    elmaY=Math.floor(Math.random()*tileCount);
                    document.getElementById("skor").innerText = skor;
                }
                ctx.fillStyle="red"; ctx.fillRect(elmaX*tileCount, elmaY*tileCount, tileSize, tileSize);
            }
            function reset() { xHiz=0; yHiz=0; headX=10; headY=10; kuyruk=2; skor=0; yilanParcalari=[]; document.getElementById("skor").innerText=0; }
            function tusBasildi(e) {
                if([37,38,39,40,65,87,68,83].indexOf(e.keyCode)>-1) e.preventDefault();
                if(yonDegisti) return;
                if((e.keyCode==37||e.keyCode==65) && xHiz!=1) {xHiz=-1; yHiz=0; yonDegisti=true;}
                if((e.keyCode==38||e.keyCode==87) && yHiz!=1) {xHiz=0; yHiz=-1; yonDegisti=true;}
                if((e.keyCode==39||e.keyCode==68) && xHiz!=-1) {xHiz=1; yHiz=0; yonDegisti=true;}
                if((e.keyCode==40||e.keyCode==83) && yHiz!=-1) {xHiz=0; yHiz=1; yonDegisti=true;}
            }
        }
        document.getElementById("enYuksek").innerText = localStorage.getItem("snakeEnYuksek") || 0;
    </script>
</body>
</html>